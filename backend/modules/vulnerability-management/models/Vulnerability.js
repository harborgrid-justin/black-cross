const mongoose = require('mongoose');
const { v4: uuidv4 } = require('uuid');

const VulnerabilitySchema = new mongoose.Schema({
  id: {
    type: String, default: uuidv4, unique: true, index: true,
  },
  cve_id: { type: String, index: true },
  title: { type: String, required: true },
  description: String,
  severity: { type: String, enum: ['critical', 'high', 'medium', 'low', 'informational'], required: true },
  cvss_score: { type: Number, min: 0, max: 10 },
  status: {
    type: String,
    enum: ['open', 'in_progress', 'patched', 'mitigated', 'accepted', 'false_positive'],
    default: 'open',
  },
  affected_assets: [{
    asset_id: String,
    asset_name: String,
    version: String,
    criticality: String,
  }],
  patch_available: Boolean,
  patch_info: {
    version: String,
    release_date: Date,
    url: String,
  },
  exploit_available: Boolean,
  priority_score: Number,
  discovered_date: Date,
  published_date: Date,
  remediation: {
    description: String,
    steps: [String],
    estimated_time: Number,
  },
  tags: [String],
  references: [String],
  metadata: mongoose.Schema.Types.Mixed,
}, { timestamps: { createdAt: 'created_at', updatedAt: 'updated_at' } });

VulnerabilitySchema.index({ severity: 1, status: 1 });
VulnerabilitySchema.index({ cvss_score: -1 });

module.exports = mongoose.model('Vulnerability', VulnerabilitySchema);
