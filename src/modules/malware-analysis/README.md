# Malware Analysis & Sandbox Module

## Overview

Complete implementation of the Malware Analysis & Sandbox module with full business logic, data logic, and database integration.

## Features Implemented

### 12.1 Automated Malware Submission
- Multi-format file submission
- Automated duplicate detection using hash comparison
- Queue management with priority support
- Bulk submission capability
- Submission tracking and status updates

### 12.2 Dynamic and Static Analysis
- **Static Analysis**:
  - String extraction from binaries
  - Entropy calculation for packing detection
  - PE/ELF header analysis
  - Import/Export table parsing
  - Packer detection
  - Anti-analysis technique detection
  - Code obfuscation detection

- **Dynamic Analysis**:
  - Process creation monitoring
  - API call tracking
  - Network activity capture
  - Memory dump collection
  - Simulated sandbox execution

### 12.3 Behavioral Analysis Reports
- File operation tracking
- Registry modification monitoring
- Dropped file analysis
- Mutex creation tracking
- Execution timeline generation
- Comprehensive behavior reports with risk assessment

### 12.4 Sandbox Environment Management
- Multi-OS support (Windows, Linux, macOS)
- Virtual machine configuration
- Resource allocation and monitoring
- Environment templates
- Snapshot creation and restoration
- Execution tracking and statistics

### 12.5 Malware Family Classification
- Signature-based classification
- Behavior-based classification
- YARA rule matching
- ML-based classification (simulated)
- Confidence scoring
- Manual classification override
- Multi-factor result aggregation

### 12.6 IOC Extraction from Samples
- IP address extraction
- Domain name extraction
- URL extraction
- Email address extraction
- File hash identification
- Registry key extraction
- Mutex identification
- Cryptocurrency address extraction
- Multiple export formats (JSON, CSV, STIX, MISP)
- IOC search across all samples

### 12.7 YARA Rule Generation
- Automatic rule generation from samples
- String pattern extraction
- Customizable rule parameters
- Rule versioning and history
- Rule testing and validation
- Rule export and import
- Community rule sharing support

## Architecture

```
malware-analysis/
├── config/           # Database configuration
├── models/          # MongoDB data models
│   ├── MalwareSample.js
│   ├── SandboxEnvironment.js
│   └── YaraRule.js
├── services/        # Business logic layer
│   ├── submissionService.js
│   ├── staticAnalysisService.js
│   ├── dynamicAnalysisService.js
│   ├── behavioralAnalysisService.js
│   ├── sandboxService.js
│   ├── classificationService.js
│   ├── iocExtractionService.js
│   └── yaraService.js
├── controllers/     # HTTP request handlers
│   ├── malwareController.js
│   └── sandboxController.js
├── routes/          # API route definitions
│   ├── malwareRoutes.js
│   └── sandboxRoutes.js
├── validators/      # Input validation schemas
│   ├── malwareValidator.js
│   └── sandboxValidator.js
├── utils/           # Helper utilities
│   ├── hashUtils.js
│   ├── patternExtractor.js
│   └── logger.js
└── index.js         # Module entry point
```

## API Endpoints

### Malware Submission
- `POST /api/v1/malware/submit` - Submit malware sample
- `GET /api/v1/malware/submissions` - List submissions with filters
- `GET /api/v1/malware/submissions/:id` - Get submission by ID
- `GET /api/v1/malware/queue/stats` - Get queue statistics

### Static Analysis
- `POST /api/v1/malware/:id/static-analysis` - Perform static analysis
- `GET /api/v1/malware/:id/static-analysis` - Get static analysis results

### Dynamic Analysis
- `POST /api/v1/malware/:id/dynamic-analysis` - Perform dynamic analysis
- `GET /api/v1/malware/:id/dynamic-analysis` - Get dynamic analysis results

### Behavioral Analysis
- `GET /api/v1/malware/:id/behavior` - Get behavioral analysis
- `GET /api/v1/malware/:id/report` - Generate comprehensive report

### Classification
- `POST /api/v1/malware/classify` - Classify malware sample
- `GET /api/v1/malware/:id/family` - Get malware family
- `POST /api/v1/malware/:id/classify` - Manual classification override

### IOC Management
- `POST /api/v1/malware/:id/extract-iocs` - Extract IOCs from sample
- `GET /api/v1/malware/:id/iocs` - Get extracted IOCs
- `GET /api/v1/malware/:id/iocs/export` - Export IOCs (JSON/CSV/STIX/MISP)
- `GET /api/v1/malware/iocs/search` - Search IOCs across samples

### YARA Rules
- `POST /api/v1/malware/:id/generate-yara` - Generate YARA rule
- `GET /api/v1/malware/yara/rules` - List YARA rules
- `GET /api/v1/malware/yara/rules/:ruleId` - Get YARA rule
- `POST /api/v1/malware/yara/rules/:ruleId/test` - Test YARA rule
- `GET /api/v1/malware/yara/rules/export` - Export YARA rules

### Sandbox Management
- `POST /api/v1/sandbox/environments` - Create sandbox environment
- `GET /api/v1/sandbox/environments` - List environments
- `GET /api/v1/sandbox/environments/:id` - Get environment details
- `PUT /api/v1/sandbox/environments/:id` - Update environment
- `DELETE /api/v1/sandbox/environments/:id` - Delete environment
- `POST /api/v1/sandbox/environments/:id/status` - Update status
- `GET /api/v1/sandbox/environments/available` - Get available environments
- `POST /api/v1/sandbox/environments/:id/reserve` - Reserve environment
- `POST /api/v1/sandbox/environments/:id/snapshot` - Create snapshot
- `POST /api/v1/sandbox/environments/:id/restore` - Restore from snapshot
- `GET /api/v1/sandbox/stats` - Get environment statistics

## Data Models

### Malware Sample
```javascript
{
  id: String (UUID),
  file_name: String,
  file_size: Number,
  file_type: String,
  md5: String,
  sha1: String,
  sha256: String,
  submitted_at: Date,
  submitted_by: String,
  status: Enum (pending, queued, analyzing, completed, failed, error),
  priority: Enum (low, medium, high, critical),
  malware_family: String,
  classification: Enum (trojan, ransomware, worm, virus, backdoor, etc.),
  threat_level: Enum (critical, high, medium, low, info),
  confidence_score: Number (0-100),
  static_analysis: {
    strings: [String],
    entropy: Number,
    pe_headers: Object,
    imports: [String],
    exports: [String],
    packer_detected: Boolean,
    anti_analysis_detected: Boolean,
    obfuscation_detected: Boolean
  },
  dynamic_analysis: {
    execution_time: Number,
    processes_created: [Object],
    api_calls: [Object],
    network_activity: [Object],
    memory_dumps: [Object]
  },
  behavioral_analysis: {
    file_operations: [Object],
    registry_operations: [Object],
    dropped_files: [Object],
    mutexes_created: [String],
    timeline: [Object]
  },
  iocs: [Object],
  yara_matches: [Object],
  sandbox_execution: Object
}
```

### Sandbox Environment
```javascript
{
  id: String (UUID),
  name: String,
  description: String,
  os_type: Enum (windows, linux, macos),
  os_version: String,
  architecture: Enum (x86, x64, arm, arm64),
  status: Enum (active, inactive, maintenance, error),
  vm_config: {
    cpu_cores: Number,
    memory_mb: Number,
    disk_gb: Number,
    network_enabled: Boolean,
    network_mode: Enum (isolated, simulated, real)
  },
  installed_software: [Object],
  snapshot_id: String,
  template: Boolean,
  resource_usage: Object,
  execution_count: Number,
  last_used: Date
}
```

### YARA Rule
```javascript
{
  id: String (UUID),
  rule_name: String,
  namespace: String,
  tags: [String],
  meta: {
    author: String,
    description: String,
    reference: String,
    date: Date,
    version: String,
    malware_family: String,
    severity: String
  },
  rule_content: String,
  strings_section: [Object],
  condition: String,
  generated_from_sample: String,
  tested: Boolean,
  test_results: Object,
  status: Enum (draft, active, deprecated, archived),
  version_history: [Object]
}
```

## Usage Examples

### Submit a Malware Sample
```bash
curl -X POST http://localhost:8080/api/v1/malware/submit \
  -H "Content-Type: application/json" \
  -d '{
    "file_data": "base64_encoded_file_content",
    "metadata": {
      "file_name": "suspicious.exe",
      "file_type": "executable",
      "submitted_by": "analyst@example.com",
      "priority": "high",
      "tags": ["suspicious", "email-attachment"]
    }
  }'
```

### Perform Static Analysis
```bash
curl -X POST http://localhost:8080/api/v1/malware/{sample-id}/static-analysis \
  -H "Content-Type: application/json" \
  -d '{
    "file_data": "base64_encoded_file_content"
  }'
```

### Classify Malware
```bash
curl -X POST http://localhost:8080/api/v1/malware/classify \
  -H "Content-Type: application/json" \
  -d '{
    "sample_id": "sample-uuid"
  }'
```

### Extract IOCs
```bash
curl -X POST http://localhost:8080/api/v1/malware/{sample-id}/extract-iocs
```

### Generate YARA Rule
```bash
curl -X POST http://localhost:8080/api/v1/malware/{sample-id}/generate-yara \
  -H "Content-Type: application/json" \
  -d '{
    "rule_name": "custom_malware_rule",
    "namespace": "custom",
    "author": "analyst",
    "max_strings": 15,
    "min_length": 8
  }'
```

### Create Sandbox Environment
```bash
curl -X POST http://localhost:8080/api/v1/sandbox/environments \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Win10_x64_1",
    "description": "Windows 10 64-bit analysis environment",
    "os_type": "windows",
    "os_version": "10.0.19042",
    "architecture": "x64",
    "vm_config": {
      "cpu_cores": 4,
      "memory_mb": 4096,
      "disk_gb": 100,
      "network_enabled": true,
      "network_mode": "simulated"
    }
  }'
```

### Get Comprehensive Report
```bash
curl http://localhost:8080/api/v1/malware/{sample-id}/report
```

### Export IOCs in STIX Format
```bash
curl http://localhost:8080/api/v1/malware/{sample-id}/iocs/export?format=stix
```

### Search IOCs
```bash
curl http://localhost:8080/api/v1/malware/iocs/search?value=192.168.1.100&type=ip
```

## Database Requirements

- **MongoDB**: Primary database for malware samples, environments, and YARA rules
- **Connection String**: Set in `MONGODB_URI` environment variable
- **Default**: `mongodb://localhost:27017/blackcross`

## Configuration

Environment variables:
```
MONGODB_URI=mongodb://localhost:27017/blackcross
LOG_LEVEL=info
```

## Business Logic Highlights

### Duplicate Detection
- Hash-based deduplication (SHA256, SHA1, MD5)
- Prevents redundant analysis of known samples
- Links duplicate submissions to existing records

### Multi-Method Classification
- Combines signature-based, behavior-based, and YARA matching
- Aggregates results from multiple classification methods
- Provides confidence scores for transparency
- Supports manual override for expert analysis

### IOC Extraction Pipeline
- Pattern-based extraction using regex
- Context-aware IOC identification
- Confidence scoring based on source
- Deduplication and aggregation
- Multiple export formats for integration

### YARA Rule Generation
- Intelligent string selection
- Filters common strings to improve rule quality
- Customizable thresholds and parameters
- Automatic versioning and history tracking
- Rule testing framework

### Sandbox Management
- Environment pooling and resource tracking
- Snapshot-based clean state restoration
- Usage statistics for load balancing
- Template support for quick provisioning

## Performance Considerations

- Indexed fields for fast queries (hashes, status, timestamps)
- Pagination support for large result sets
- Async/await for non-blocking operations
- Efficient regex patterns for IOC extraction
- Batch operation support

## Security

- Input validation using Joi schemas
- Sanitized database queries
- Audit logging for all operations
- Hash-based file identification
- Isolated sandbox execution (simulated)

## Testing

The module includes comprehensive business logic that can be tested with:
```bash
npm test src/modules/malware-analysis
```

## Integration

To integrate this module into the main application:

```javascript
const malwareAnalysis = require('./modules/malware-analysis');

// Initialize module
await malwareAnalysis.initialize();

// Mount routes
app.use('/api/v1', malwareAnalysis.router);
```

## Future Enhancements

- Real sandbox integration (Cuckoo, CAPE, Any.run)
- Machine learning-based classification models
- VirusTotal API integration
- Automated unpacking
- Memory forensics analysis
- YARA rule scanning engine
- Real-time analysis streaming
- Collaborative analysis features
- Threat intelligence feed integration
- Advanced visualization dashboards

## License

MIT
