/**
 * CVE (Common Vulnerabilities and Exposures) Model
 *
 * Tracks CVE information from external sources like NVD
 */

const { v4: uuidv4 } = require('uuid');

class CVE {
  constructor(data = {}) {
    this.id = data.id || uuidv4();
    this.cve_id = data.cve_id || ''; // e.g., CVE-2024-12345
    this.description = data.description || '';
    this.published_date = data.published_date || null;
    this.last_modified_date = data.last_modified_date || null;
    this.cvss_v3_score = data.cvss_v3_score || null;
    this.cvss_v3_vector = data.cvss_v3_vector || null;
    this.cvss_v2_score = data.cvss_v2_score || null;
    this.cvss_v2_vector = data.cvss_v2_vector || null;
    this.severity = data.severity || 'medium'; // critical, high, medium, low
    this.cwe_ids = data.cwe_ids || []; // Common Weakness Enumeration
    this.references = data.references || [];
    this.affected_products = data.affected_products || [];
    this.exploit_available = data.exploit_available !== undefined ? data.exploit_available : false;
    this.exploit_maturity = data.exploit_maturity || null; // unproven, proof_of_concept, functional, high
    this.patch_available = data.patch_available !== undefined ? data.patch_available : false;
    this.vendor_advisories = data.vendor_advisories || [];
    this.trending = data.trending !== undefined ? data.trending : false;
    this.epss_score = data.epss_score || null; // Exploit Prediction Scoring System
    this.created_at = data.created_at || new Date();
    this.updated_at = data.updated_at || new Date();
  }

  /**
   * Check if CVE is critical based on score and exploitability
   */
  isCritical() {
    return (
      this.severity === 'critical'
      || (this.cvss_v3_score && this.cvss_v3_score >= 9.0)
      || (this.exploit_available && this.cvss_v3_score >= 7.0)
    );
  }

  /**
   * Get primary CVSS score (prefer v3 over v2)
   */
  getCVSSScore() {
    return this.cvss_v3_score || this.cvss_v2_score || 0;
  }

  /**
   * Convert to plain object for storage/API
   */
  toJSON() {
    return {
      id: this.id,
      cve_id: this.cve_id,
      description: this.description,
      published_date: this.published_date,
      last_modified_date: this.last_modified_date,
      cvss_v3_score: this.cvss_v3_score,
      cvss_v3_vector: this.cvss_v3_vector,
      cvss_v2_score: this.cvss_v2_score,
      cvss_v2_vector: this.cvss_v2_vector,
      severity: this.severity,
      cwe_ids: this.cwe_ids,
      references: this.references,
      affected_products: this.affected_products,
      exploit_available: this.exploit_available,
      exploit_maturity: this.exploit_maturity,
      patch_available: this.patch_available,
      vendor_advisories: this.vendor_advisories,
      trending: this.trending,
      epss_score: this.epss_score,
      created_at: this.created_at,
      updated_at: this.updated_at
    };
  }
}

module.exports = CVE;
